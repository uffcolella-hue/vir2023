<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
<meta name="apple-mobile-web-app-title" content="Ship Survey"/>
<title>Ship Survey Draft</title>
<style>
:root{
  --navy:#0a1628;--blue:#1565C0;--blue2:#1976D2;--blue3:#42A5F5;
  --white:#fff;--g1:#F8F9FA;--g2:#ECEFF1;--g3:#CFD8DC;--g4:#90A4AE;
  --text:#263238;--text2:#455A64;--text3:#78909C;
  --red:#C62828;--red2:#E53935;--green2:#2E7D32;--green3:#43A047;
  --border:#DDE3EC;--r:14px;--rs:9px;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;-webkit-font-smoothing:antialiased;}
html,body{font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",Helvetica,Arial,sans-serif;background:#F0F4F8;color:var(--text);-webkit-text-size-adjust:100%;}
.screen{display:none;flex-direction:column;min-height:100vh;}
.screen.active{display:flex;}
.topbar{background:linear-gradient(160deg,#0a1628,#1565C0);padding:calc(env(safe-area-inset-top,0px) + 12px) 16px 14px;display:flex;align-items:center;gap:12px;position:sticky;top:0;z-index:100;box-shadow:0 2px 10px rgba(0,0,0,.3);}
.back-btn{width:34px;height:34px;border-radius:50%;background:rgba(255,255,255,.15);border:none;color:#fff;font-size:22px;font-weight:300;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.tb-txt{flex:1;color:#fff;min-width:0;}
.tb-txt h1{font-size:17px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.tb-txt p{font-size:11px;color:rgba(255,255,255,.65);margin-top:1px;}
.tb-btn{background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.3);color:#fff;border-radius:9px;padding:7px 13px;font-size:13px;font-weight:600;cursor:pointer;white-space:nowrap;flex-shrink:0;}
.pb{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:16px;padding-bottom:calc(70px + env(safe-area-inset-bottom,0px));}
.pb.np{padding:0;padding-bottom:calc(70px + env(safe-area-inset-bottom,0px));}
.hero{background:linear-gradient(160deg,#0d1f3c,#1976D2);border-radius:16px;padding:22px 20px;margin-bottom:18px;color:#fff;text-align:center;}
.hero .bi{font-size:44px;margin-bottom:8px;}
.hero h2{font-size:21px;font-weight:800;margin-bottom:4px;}
.hero p{font-size:13px;color:rgba(255,255,255,.7);}
.hero .dc{display:inline-block;background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.25);border-radius:20px;padding:4px 14px;font-size:12px;font-weight:600;margin-top:10px;}
.slbl{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1.1px;color:var(--text3);margin-bottom:8px;padding-left:2px;}
.sc{background:#fff;border-radius:var(--r);border:1px solid var(--border);padding:13px 13px;margin-bottom:9px;display:flex;align-items:center;gap:12px;cursor:pointer;box-shadow:0 1px 6px rgba(0,0,0,.06);}
.sc:active{opacity:.8;}
.snum{width:40px;height:40px;border-radius:11px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:15px;font-weight:800;color:#fff;}
.si{flex:1;min-width:0;}
.si h3{font-size:15px;font-weight:700;color:var(--text);margin-bottom:2px;}
.si .sub{font-size:11px;color:var(--text3);}
.pbw{height:4px;background:var(--g2);border-radius:2px;margin-top:5px;}
.pbr{height:100%;border-radius:2px;}
.sn{text-align:right;flex-shrink:0;}
.sn .n{font-size:13px;font-weight:700;color:var(--blue2);}
.sn .l{font-size:10px;color:var(--text3);}
.sn .fn{font-size:13px;font-weight:700;color:var(--red2);}
.arr{color:var(--g4);font-size:18px;flex-shrink:0;}
.sumbox{background:#fff;border-radius:var(--r);border:1px solid var(--border);padding:14px 16px;margin-top:4px;display:grid;grid-template-columns:repeat(3,1fr);gap:8px;}
.smi{text-align:center;}
.smv{font-size:24px;font-weight:800;}
.sml{font-size:10px;color:var(--text3);margin-top:1px;}
.blue{color:var(--blue2);}
.red{color:var(--red2);}
.green{color:var(--green3);}
.bg1{background:linear-gradient(135deg,#1565C0,#1976D2);}
.bg2{background:linear-gradient(135deg,#00695C,#00897B);}
.bg3{background:linear-gradient(135deg,#4527A0,#5E35B1);}
.bg4{background:linear-gradient(135deg,#E65100,#F57C00);}
.bg5{background:linear-gradient(135deg,#B71C1C,#C62828);}
.bg6{background:linear-gradient(135deg,#006064,#00838F);}
.bg7{background:linear-gradient(135deg,#33691E,#558B2F);}
.bg8{background:linear-gradient(135deg,#4E342E,#6D4C41);}
.expbtn{display:flex;align-items:center;gap:10px;width:100%;padding:13px 16px;background:#fff;border:1.5px solid var(--border);border-radius:var(--r);color:var(--text);font-size:14px;font-weight:600;cursor:pointer;margin-bottom:9px;}
.expbtn:active{background:var(--g1);}
.subsep{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:#fff;background:var(--blue2);border-radius:8px;padding:7px 14px;margin:0 16px 10px;display:flex;align-items:center;gap:6px;}
.swrap{padding:0 16px 4px;}
.sbox{background:#fff;border:1.5px solid var(--border);border-radius:var(--rs);margin-bottom:9px;overflow:hidden;}
.sbox.req{border-left:3px solid var(--red2);}
.shd{padding:9px 12px;display:flex;align-items:center;gap:8px;border-bottom:1px solid var(--g2);}
.snm{font-size:13px;font-weight:600;color:var(--text);flex:1;}
.breq{font-size:10px;color:var(--red2);font-weight:700;background:rgba(198,40,40,.09);padding:2px 7px;border-radius:5px;white-space:nowrap;}
.bok{font-size:10px;color:var(--green3);font-weight:700;background:rgba(67,160,71,.1);padding:2px 7px;border-radius:5px;white-space:nowrap;}
.sbdy{padding:9px 12px;display:flex;gap:10px;align-items:flex-start;}
.sthumb{width:70px;height:54px;border-radius:8px;border:1.5px dashed var(--g3);background:var(--g1);display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;overflow:hidden;position:relative;}
.sthumb.filled{border-style:solid;border-color:#42A5F5;}
.sthumb img{width:100%;height:100%;object-fit:cover;}
.sthumb .cic{font-size:22px;color:#42A5F5;}
.dph{position:absolute;top:2px;right:2px;width:18px;height:18px;background:rgba(198,40,40,.85);border-radius:50%;border:none;color:#fff;font-size:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:5;}
.sna{flex:1;}
.sna textarea{width:100%;background:var(--g1);border:1px solid var(--g3);border-radius:7px;color:var(--text);font-size:13px;font-family:inherit;padding:8px 10px;outline:none;resize:none;min-height:48px;line-height:1.4;}
.sna textarea:focus{border-color:#42A5F5;background:#fff;}
.fwrap{padding:0 16px;}
.fcard{background:#fff;border:1px solid var(--border);border-radius:var(--r);margin-bottom:9px;overflow:hidden;box-shadow:0 1px 5px rgba(0,0,0,.06);}
.fhd{padding:9px 13px;display:flex;align-items:flex-start;gap:8px;border-bottom:1px solid var(--g2);}
.tbadge{font-size:10px;font-weight:700;padding:3px 8px;border-radius:5px;text-transform:uppercase;letter-spacing:.3px;white-space:nowrap;flex-shrink:0;}
.tbp{background:rgba(21,101,192,.1);color:#1565C0;}
.tbd{background:rgba(198,40,40,.12);color:#C62828;}
.tbn{background:rgba(74,20,140,.1);color:#4A148C;}
.tbc{background:rgba(230,81,0,.12);color:#E65100;}
.tbo{background:rgba(0,96,100,.1);color:#006064;}
.tbph{background:rgba(33,33,33,.1);color:#333;}
.tbpo{background:rgba(27,94,32,.12);color:#1B5E20;}
.fdesc{font-size:13px;font-weight:500;color:var(--text);flex:1;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
.fbdy{padding:9px 13px;display:flex;gap:10px;align-items:flex-start;}
.fimg{width:62px;height:50px;border-radius:7px;object-fit:cover;flex-shrink:0;}
.fimph{width:62px;height:50px;border-radius:7px;background:var(--g2);flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:18px;color:var(--g4);}
.fmeta{flex:1;}
.fmeta .row{font-size:11px;color:var(--text3);margin-bottom:3px;line-height:1.3;}
.fft{border-top:1px solid var(--g2);padding:7px 13px;display:flex;justify-content:flex-end;gap:8px;}
.bts{padding:6px 12px;border-radius:7px;border:1px solid var(--g3);background:var(--g1);color:var(--text2);font-size:12px;font-weight:600;cursor:pointer;}
.bts.del{border-color:rgba(198,40,40,.25);background:rgba(198,40,40,.05);color:var(--red2);}
.btadd{width:100%;padding:14px;border-radius:var(--r);background:linear-gradient(135deg,#0d1f3c,#1565C0);border:none;color:#fff;font-size:15px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;box-shadow:0 4px 14px rgba(21,101,192,.35);margin-bottom:4px;}
.btadd:active{opacity:.85;}
.fmcard{background:#fff;border-radius:var(--r);border:1px solid var(--border);padding:15px;margin-bottom:12px;}
.fmttl{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:var(--text3);margin-bottom:11px;}
.flbl{font-size:13px;font-weight:600;color:var(--text2);margin-bottom:5px;display:block;}
.fgrp{margin-bottom:13px;}
.fgrp:last-child{margin-bottom:0;}
.finp{display:block;width:100%;background:var(--g1);border:1.5px solid var(--g3);border-radius:var(--rs);color:var(--text);font-size:15px;font-family:inherit;padding:11px 13px;outline:none;-webkit-appearance:none;}
textarea.finp{resize:none;min-height:85px;line-height:1.5;}
.finp:focus{border-color:#42A5F5;background:#fff;box-shadow:0 0 0 3px rgba(66,165,245,.12);}
.finp::placeholder{color:var(--text3);}
.tgrid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.topt{padding:11px 8px;border-radius:9px;border:1.5px solid var(--g3);background:var(--g1);cursor:pointer;text-align:center;}
.topt .tic{font-size:19px;margin-bottom:3px;}
.topt .tlb{font-size:11px;font-weight:600;color:var(--text2);line-height:1.2;}
.topt.sbp{border-color:#1565C0;background:rgba(21,101,192,.07);} .topt.sbp .tlb{color:#1565C0;}
.topt.sdf{border-color:#C62828;background:rgba(198,40,40,.07);} .topt.sdf .tlb{color:#C62828;}
.topt.sno{border-color:#4A148C;background:rgba(74,20,140,.07);} .topt.sno .tlb{color:#4A148C;}
.topt.snc{border-color:#E65100;background:rgba(230,81,0,.07);}  .topt.snc .tlb{color:#E65100;}
.topt.sob{border-color:#006064;background:rgba(0,96,100,.07);}  .topt.sob .tlb{color:#006064;}
.topt.sph{border-color:#333;background:rgba(0,0,0,.04);}        .topt.sph .tlb{color:#333;}
.topt.spo{border-color:#1B5E20;background:rgba(27,94,32,.07);}  .topt.spo .tlb{color:#1B5E20;}
.parea{width:100%;aspect-ratio:4/3;background:var(--g1);border-radius:var(--r);border:2px dashed var(--g3);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;overflow:hidden;position:relative;}
.parea.has{border-style:solid;border-color:#42A5F5;}
.parea img{width:100%;height:100%;object-fit:cover;}
.pph{text-align:center;padding:20px;}
.pph .pi{font-size:36px;opacity:.4;margin-bottom:8px;}
.pph .pt{font-size:14px;color:var(--text2);font-weight:500;}
.pph .ps{font-size:11px;color:var(--text3);margin-top:4px;}
.pover{position:absolute;bottom:0;left:0;right:0;background:linear-gradient(transparent,rgba(0,0,0,.6));padding:12px 10px 8px;display:flex;gap:8px;}
.pover button{flex:1;padding:8px;border-radius:7px;border:none;font-size:12px;font-weight:700;cursor:pointer;}
.bret{background:rgba(255,255,255,.2);color:#fff;}
.bkp{background:var(--blue2);color:#fff;}
.dtrow{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.dtbox{background:var(--g1);border:1px solid var(--g3);border-radius:var(--rs);padding:10px 12px;}
.dtic{font-size:15px;margin-bottom:3px;}
.dtlbl{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;font-weight:600;}
.dtval{font-size:13px;font-weight:600;color:var(--text);margin-top:2px;}
.btsave{width:100%;padding:16px;background:linear-gradient(135deg,#0a1628,#1565C0);border:none;border-radius:var(--r);color:#fff;font-size:16px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;box-shadow:0 4px 16px rgba(21,101,192,.4);}
.btsave:active{opacity:.85;}
.rcard{background:#fff;border-radius:var(--r);border:1px solid var(--border);margin-bottom:11px;overflow:hidden;}
.rhd{background:var(--g1);padding:9px 13px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);}
.rsn{font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;}
.rbdy{padding:12px 13px;}
.rimg{width:100%;max-height:200px;object-fit:cover;border-radius:8px;margin-bottom:9px;}
.rdesc{font-size:14px;color:var(--text);font-weight:500;line-height:1.4;margin-bottom:8px;}
.rmeta{display:grid;grid-template-columns:1fr 1fr;gap:6px;}
.rmi{background:var(--g1);border-radius:7px;padding:7px 10px;}
.rmi .rl{font-size:10px;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:.3px;}
.rmi .rv{font-size:12px;color:var(--text);margin-top:2px;}
.ract{background:rgba(21,101,192,.05);border:1px solid rgba(21,101,192,.12);border-radius:7px;padding:8px 10px;margin-top:7px;}
.ract .al{font-size:10px;color:var(--blue2);font-weight:700;text-transform:uppercase;letter-spacing:.3px;}
.ract .av{font-size:12px;color:var(--text);margin-top:3px;line-height:1.4;}
.empty{text-align:center;padding:40px 20px;color:var(--text3);}
.empty .ei{font-size:46px;opacity:.25;margin-bottom:10px;}
.empty p{font-size:14px;font-weight:500;}
.toast{position:fixed;bottom:calc(80px + env(safe-area-inset-bottom,0px));left:50%;transform:translateX(-50%) translateY(20px);background:#263238;color:#fff;padding:11px 22px;border-radius:22px;font-size:14px;font-weight:600;z-index:9999;opacity:0;transition:all .3s;pointer-events:none;white-space:nowrap;box-shadow:0 4px 18px rgba(0,0,0,.3);}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
.toast.ok{background:var(--green2);}
.toast.er{background:var(--red2);}
</style>
</head>
<body>

<!-- HOME -->
<div class="screen active" id="S-home">
  <div class="topbar">
    <div class="tb-txt"><h1>Ship Survey Draft</h1><p id="hDate">—</p></div>
    <button class="tb-btn" id="btnReview">Review All</button>
  </div>
  <div class="pb">
    <div class="hero">
      <div class="bi">&#9875;</div>
      <h2>Vessel Inspection</h2>
      <p>Draft tool — fill sections, add findings &amp; photos</p>
      <div class="dc" id="hDateChip">—</div>
    </div>
    <div class="slbl">Inspection Sections</div>
    <div id="secList"></div>
    <div class="slbl" style="margin-top:16px;">Summary</div>
    <div class="sumbox">
      <div class="smi"><div class="smv blue" id="sumPh">0</div><div class="sml">Photos</div></div>
      <div class="smi"><div class="smv red" id="sumFi">0</div><div class="sml">Findings</div></div>
      <div class="smi"><div class="smv green" id="sumSe">0</div><div class="sml">Sections</div></div>
    </div>
    <div style="margin-top:14px;">
      <button class="expbtn" id="btnExpJSON"><span style="font-size:20px;">&#128196;</span> Export as JSON</button>
      <button class="expbtn" id="btnExpCSV"><span style="font-size:20px;">&#128202;</span> Export as CSV</button>
    </div>
  </div>
</div>

<!-- SECTION -->
<div class="screen" id="S-section">
  <div class="topbar">
    <button class="back-btn" id="btnSecBack">&#8249;</button>
    <div class="tb-txt"><h1 id="secTopTitle">Section</h1><p id="secTopSub">Photos &amp; Findings</p></div>
  </div>
  <div class="pb np" id="secBody"></div>
</div>

<!-- FINDING -->
<div class="screen" id="S-finding">
  <div class="topbar">
    <button class="back-btn" id="btnFindBack">&#8249;</button>
    <div class="tb-txt"><h1 id="fTitle">Add Finding</h1><p id="fSub">—</p></div>
  </div>
  <div class="pb">
    <div class="fmcard">
      <div class="fmttl">&#128247; Photo (optional)</div>
      <div class="parea" id="photoArea">
        <div class="pph">
          <div class="pi">&#128248;</div>
          <div class="pt">Tap to take / select photo</div>
          <div class="ps">Optional</div>
        </div>
      </div>
      <input type="file" id="fCamInput" accept="image/*" capture="environment" style="display:none"/>
    </div>
    <div class="fmcard">
      <div class="fmttl">&#127991; Finding Type <span style="color:var(--red2)">*</span></div>
      <div class="tgrid" id="typeGrid">
        <div class="topt" data-k="bp"><div class="tic">&#9989;</div><div class="tlb">Best Practice</div></div>
        <div class="topt" data-k="df"><div class="tic">&#9888;</div><div class="tlb">Deficiency</div></div>
        <div class="topt" data-k="no"><div class="tic">&#128313;</div><div class="tlb">Negative Obs (OMV)</div></div>
        <div class="topt" data-k="nc"><div class="tic">&#128683;</div><div class="tlb">Non Conform. Report</div></div>
        <div class="topt" data-k="ob"><div class="tic">&#128269;</div><div class="tlb">Observation</div></div>
        <div class="topt" data-k="ph"><div class="tic">&#128247;</div><div class="tlb">Photography</div></div>
        <div class="topt" data-k="po"><div class="tic">&#128314;</div><div class="tlb">Positive Obs (OMV)</div></div>
      </div>
    </div>
    <div class="fmcard">
      <div class="fmttl">&#128203; Details</div>
      <div class="fgrp">
        <label class="flbl">Description <span style="color:var(--red2)">*</span></label>
        <textarea class="finp" id="fDesc" placeholder="Describe the finding in detail..." maxlength="800"></textarea>
      </div>
      <div class="fgrp">
        <label class="flbl">&#128205; Location</label>
        <input type="text" class="finp" id="fLoc" placeholder="e.g. Engine Room, Frame 42, Port side..." maxlength="200"/>
      </div>
      <div class="fgrp">
        <label class="flbl">&#128204; Recommendation / Action</label>
        <textarea class="finp" id="fAction" placeholder="Recommended action or notes..." maxlength="500" style="min-height:65px;"></textarea>
      </div>
    </div>
    <div class="fmcard">
      <div class="fmttl">&#128336; Date &amp; Time (auto)</div>
      <div class="dtrow">
        <div class="dtbox"><div class="dtic">&#128197;</div><div class="dtlbl">Date</div><div class="dtval" id="dtD">—</div></div>
        <div class="dtbox"><div class="dtic">&#9200;</div><div class="dtlbl">Time</div><div class="dtval" id="dtT">—</div></div>
      </div>
    </div>
    <button class="btsave" id="btnSave">&#128190; Save Finding</button>
  </div>
</div>

<!-- REVIEW -->
<div class="screen" id="S-review">
  <div class="topbar">
    <button class="back-btn" id="btnRevBack">&#8249;</button>
    <div class="tb-txt"><h1>Review All Findings</h1><p id="revSub">—</p></div>
  </div>
  <div class="pb" id="revBody"></div>
</div>

<div class="toast" id="toast"></div>

<script>
var SECS=[
  {id:'hull',num:1,bg:'bg1',name:'Hull',sub:'External hull survey',slots:[
    {k:'bow_dead',lbl:'Bow Area from dead ahead'},
    {k:'hfw_sb',lbl:'Hull forward end (Starboard side)'},
    {k:'hfw_pt',lbl:'Hull forward end (Port side)'},
    {k:'haf_sb',lbl:'Hull after end (Starboard side)'},
    {k:'haf_pt',lbl:'Hull after end (Port side)'},
    {k:'haft_pt',lbl:'Hull aft end (Port side)'},
    {k:'transom',lbl:'Transom from dead astern'},
    {k:'loadline',lbl:'Loadline markings'}
  ]},
  {id:'deck',num:2,bg:'bg2',name:'Deck',sub:'Deck equipment & fittings',slots:[
    {k:'fc_pt',lbl:'Forecastle port side'},
    {k:'fc_sb',lbl:'Forecastle starboard side'},
    {k:'windlass',lbl:'Port or starboard windlass'},
    {k:'fwd_deck',lbl:'Forward main deck'},
    {k:'moor_winch',lbl:'Mooring Winches'},
    {k:'mid_pt',lbl:'Main deck midships (port)'},
    {k:'mid_sb',lbl:'Main deck midships (starboard)'},
    {k:'aft_pt',lbl:'Aft main deck port side'},
    {k:'aft_sb',lbl:'Aft main deck starboard side'},
    {k:'poop',lbl:'Poop deck looking from midships'},
    {k:'gang_pt',lbl:'Gangway / Accommodation Ladder (Port)'},
    {k:'gang_sb',lbl:'Gangway / Accommodation Ladder (Starboard)'},
    {k:'pilot_pt',lbl:'Pilot Ladder (Port)'},
    {k:'pilot_sb',lbl:'Pilot Ladder (Starboard)'},
    {k:'hatch_cov',lbl:'Hatch Covers'},
    {k:'hatch_seal',lbl:'Hatch Covers Seals'},
    {k:'holds1',lbl:'Holds from top view (selection) #1'},
    {k:'holds2',lbl:'Holds from top view (selection) #2'}
  ]},
  {id:'superstr',num:3,bg:'bg3',name:'Superstructure',sub:'External superstructure & doors',slots:[
    {k:'sup_pt',lbl:'External superstructure (Port)'},
    {k:'sup_sb',lbl:'External superstructure (Starboard)'},
    {k:'funnel',lbl:'Funnel view (port/starboard)'},
    {k:'stairs',lbl:'External staircases (selection)'},
    {k:'wt_ext',lbl:'Weathertight doors (selection) - External'},
    {k:'wt_int',lbl:'Weathertight doors incl. rubber seals - Internal'},
    {k:'dampers',lbl:'Dampers (selection)'}
  ]},
  {id:'accom',num:4,bg:'bg4',name:'Accommodation',sub:'Living spaces & crew areas',slots:[
    {k:'cabin',lbl:'Cabin (selection)'},
    {k:'galley',lbl:'Galley'},
    {k:'off_mess',lbl:'Officers Mess'},
    {k:'crew_mess',lbl:'Crew Mess'},
    {k:'hospital',lbl:'Hospital'},
    {k:'laundry',lbl:'Laundry room'},
    {k:'stores',lbl:'Stores (Selection)'}
  ]},
  {id:'machinery',num:5,bg:'bg5',name:'Machinery Spaces',sub:'Engine room & machinery',slots:[
    {k:'emerg_gen',lbl:'Emergency Generator',req:true},
    {k:'accum_bat',lbl:'Accumulator Batteries',req:true},
    {k:'er_gen',lbl:'Engine room general view - top of main engine',req:true},
    {k:'gen_eng',lbl:'One generator engine',req:true},
    {k:'oil_flt',lbl:'Oil Filtering Equipment',req:true},
    {k:'boil_frt',lbl:'One boiler from front',req:true},
    {k:'boil_top',lbl:'One boiler from top showing control equipment',req:true},
    {k:'purifier',lbl:'Purifier room general view',req:true},
    {k:'me_side',lbl:'Main engine side (port/stbd) - local control',req:true},
    {k:'steer_rm',lbl:'Steering gear room general view',req:true},
    {k:'main_steer',lbl:'Main steering gear',req:true},
    {k:'overboard',lbl:'Overboard discharge valve',req:true}
  ]},
  {id:'bridge',num:6,bg:'bg6',name:'Bridge',sub:'Navigation bridge & equipment',slots:[
    {k:'br_gen',lbl:'General bridge view'},
    {k:'br_wings',lbl:'Bridge wings'},
    {k:'br_funnel',lbl:'Funnel view (port/starboard)'}
  ]},
  {id:'emergency',num:7,bg:'bg7',name:'Emergency Equipment',sub:'Life-saving & fire-fighting',slots:[
    {k:'lifeboats',lbl:'Lifeboats & Rescue Boats'},
    {k:'liferafts',lbl:'Life Rafts'},
    {k:'fire_eq',lbl:'Fire Fighting Equipment'},
    {k:'imm_suits',lbl:'Immersion Suits (selection)'},
    {k:'muster',lbl:'Muster Station'}
  ]},
  {id:'cargo',num:8,bg:'bg8',name:'Cargo Operations',sub:'Cargo handling equipment',slots:[
    {k:'conveyors',lbl:'Conveyors, buckets frames'},
    {k:'belting',lbl:'Belting Scrappers and Skirts'},
    {k:'drive_mot',lbl:'Drive Motors, Clutches and Gearboxes'}
  ]}
];

var TL={bp:'Best Practice',df:'Deficiency',no:'Negative Obs (OMV)',nc:'Non Conform. Report',ob:'Observation',ph:'Photography',po:'Positive Obs (OMV)'};
var TC={bp:'tbp',df:'tbd',no:'tbn',nc:'tbc',ob:'tbo',ph:'tbph',po:'tbpo'};
var TS={bp:'sbp',df:'sdf',no:'sno',nc:'snc',ob:'sob',ph:'sph',po:'spo'};

var ST;
try{ST=JSON.parse(localStorage.getItem('ssv2')||'null')||{photos:{},notes:{},findings:[]};}
catch(e){ST={photos:{},notes:{},findings:[]};}

var curSec=null,editId=null,fPhoto=null,selType=null,dtTmr=null;

function saveState(){try{localStorage.setItem('ssv2',JSON.stringify(ST));}catch(e){}}
function ge(id){return document.getElementById(id);}
function esc(s){return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function fmtD(d){return d.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'});}
function fmtT(d){return d.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit',second:'2-digit'});}

function toast(msg,cls){
  var t=ge('toast');
  t.textContent=msg;
  t.className='toast'+(cls?' '+cls:'');
  t.classList.add('show');
  setTimeout(function(){t.classList.remove('show');},2400);
}

function showS(id){
  var all=document.querySelectorAll('.screen');
  for(var i=0;i<all.length;i++) all[i].classList.remove('active');
  ge('S-'+id).classList.add('active');
  window.scrollTo(0,0);
}

function getSec(id){for(var i=0;i<SECS.length;i++){if(SECS[i].id===id)return SECS[i];}return null;}

/* ── HOME ── */
function initHome(){
  var now=new Date();
  var ds=fmtD(now);
  ge('hDate').textContent=ds;
  ge('hDateChip').textContent=ds;
  renderSecList();
  updateSummary();
}

function renderSecList(){
  var c=ge('secList');
  if(!c)return;
  var html='';
  for(var i=0;i<SECS.length;i++){
    var s=SECS[i];
    var ph=0;
    for(var j=0;j<s.slots.length;j++){if(ST.photos[s.slots[j].k])ph++;}
    var fi=0;
    for(var j=0;j<ST.findings.length;j++){if(ST.findings[j].sid===s.id)fi++;}
    var pct=Math.round((ph/s.slots.length)*100);
    html+='<div class="sc" data-sid="'+s.id+'">'
      +'<div class="snum '+s.bg+'">'+s.num+'</div>'
      +'<div class="si">'
        +'<h3>'+esc(s.name)+'</h3>'
        +'<div class="sub">'+esc(s.sub)+'</div>'
        +'<div class="pbw"><div class="pbr '+s.bg+'" style="width:'+pct+'%"></div></div>'
      +'</div>'
      +'<div class="sn">'
        +'<div class="n">'+ph+'/'+s.slots.length+'</div><div class="l">photos</div>'
        +'<div class="'+(fi>0?'fn':'n')+'">'+fi+'</div><div class="l">findings</div>'
      +'</div>'
      +'<div class="arr">&#8250;</div>'
      +'</div>';
  }
  c.innerHTML=html;
  var cards=c.querySelectorAll('.sc');
  for(var i=0;i<cards.length;i++){
    (function(el){
      el.addEventListener('click',function(){openSection(el.getAttribute('data-sid'));});
    })(cards[i]);
  }
}

function updateSummary(){
  var ph=Object.keys(ST.photos).length;
  var fi=ST.findings.length;
  var se=0;
  for(var i=0;i<SECS.length;i++){
    var s=SECS[i];
    var has=false;
    for(var j=0;j<s.slots.length;j++){if(ST.photos[s.slots[j].k]){has=true;break;}}
    if(!has){for(var j=0;j<ST.findings.length;j++){if(ST.findings[j].sid===s.id){has=true;break;}}}
    if(has)se++;
  }
  ge('sumPh').textContent=ph;
  ge('sumFi').textContent=fi;
  ge('sumSe').textContent=se;
}

/* ── SECTION ── */
function openSection(sid){
  curSec=sid;
  var s=getSec(sid);
  ge('secTopTitle').textContent=s.name;
  ge('secTopSub').textContent=s.slots.length+' photo slots';
  renderSecBody(s);
  showS('section');
}

function renderSecBody(s){
  var body=ge('secBody');
  var html='<div style="padding:14px 0 0;">';
  html+='<div class="subsep">&#128247; Required Photos</div>';
  html+='<div class="swrap">';
  for(var i=0;i<s.slots.length;i++){
    var sl=s.slots[i];
    var hp=!!ST.photos[sl.k];
    var nt=ST.notes[sl.k]||'';
    html+='<div class="sbox'+(sl.req?' req':'')+'">'
      +'<div class="shd">'
        +'<span class="snm">'+esc(sl.lbl)+'</span>'
        +(sl.req?'<span class="breq">&#9733; Required</span>':'')
        +(hp?'<span class="bok">&#10003; Done</span>':'')
      +'</div>'
      +'<div class="sbdy">'
        +'<div class="sthumb'+(hp?' filled':'')+'" data-k="'+sl.k+'">'
          +(hp?'<img src="'+ST.photos[sl.k]+'" alt=""/><button class="dph" data-k="'+sl.k+'">&times;</button>':'<span class="cic">&#128247;</span>')
        +'</div>'
        +'<div class="sna"><textarea data-k="'+sl.k+'" placeholder="Note (optional)...">'+esc(nt)+'</textarea></div>'
      +'</div>'
      +'</div>'
      +'<input type="file" id="si_'+sl.k+'" data-k="'+sl.k+'" accept="image/*" capture="environment" style="display:none"/>';
  }
  html+='</div>';

  var finds=[];
  for(var i=0;i<ST.findings.length;i++){if(ST.findings[i].sid===s.id)finds.push(ST.findings[i]);}
  html+='<div class="subsep" style="margin-top:6px;">&#128269; Findings ('+finds.length+')</div>';
  html+='<div class="fwrap">';
  if(finds.length===0){
    html+='<div class="empty"><div class="ei">&#128269;</div><p>No findings yet.<br>Tap below to add one.</p></div>';
  } else {
    for(var i=0;i<finds.length;i++){
      var f=finds[i];
      html+='<div class="fcard">'
        +'<div class="fhd">'
          +'<span class="tbadge '+(TC[f.type]||'tbo')+'">'+esc(TL[f.type]||f.type)+'</span>'
          +'<span class="fdesc">'+esc(f.desc)+'</span>'
        +'</div>'
        +'<div class="fbdy">'
          +(f.photo?'<img class="fimg" src="'+f.photo+'" alt=""/>':'<div class="fimph">&#128247;</div>')
          +'<div class="fmeta">'
            +'<div class="row">&#128205; '+esc(f.loc||'—')+'</div>'
            +'<div class="row">&#128197; '+esc(f.date)+' '+esc(f.time)+'</div>'
            +(f.action?'<div class="row">&#8617; '+esc(f.action.substring(0,55))+(f.action.length>55?'...':'')+'</div>':'')
          +'</div>'
        +'</div>'
        +'<div class="fft">'
          +'<button class="bts" data-edit="'+f.id+'">&#9998; Edit</button>'
          +'<button class="bts del" data-del="'+f.id+'">&#128465; Delete</button>'
        +'</div>'
        +'</div>';
    }
  }
  html+='</div>';
  html+='<div style="padding:10px 16px 4px;"><button class="btadd" id="btnAddF">&#43; Add Finding</button></div></div>';
  body.innerHTML=html;

  // bind slot thumbs
  var thumbs=body.querySelectorAll('.sthumb');
  for(var i=0;i<thumbs.length;i++){
    (function(el){
      el.addEventListener('click',function(e){
        if(e.target.classList.contains('dph'))return;
        var k=el.getAttribute('data-k');
        var inp=ge('si_'+k);
        if(inp)inp.click();
      });
    })(thumbs[i]);
  }
  // bind del photo buttons
  var dphs=body.querySelectorAll('.dph');
  for(var i=0;i<dphs.length;i++){
    (function(el){
      el.addEventListener('click',function(e){
        e.stopPropagation();
        delete ST.photos[el.getAttribute('data-k')];
        saveState();
        renderSecBody(getSec(curSec));
      });
    })(dphs[i]);
  }
  // bind file inputs
  var finps=body.querySelectorAll('input[type=file]');
  for(var i=0;i<finps.length;i++){
    (function(el){
      el.addEventListener('change',function(){
        var k=el.getAttribute('data-k');
        var file=el.files[0]; if(!file)return;
        var r=new FileReader();
        r.onload=function(ev){
          ST.photos[k]=ev.target.result;
          saveState();
          renderSecBody(getSec(curSec));
          toast('Photo saved','ok');
        };
        r.readAsDataURL(file);
      });
    })(finps[i]);
  }
  // bind note areas
  var txts=body.querySelectorAll('.sna textarea');
  for(var i=0;i<txts.length;i++){
    (function(el){
      el.addEventListener('change',function(){
        ST.notes[el.getAttribute('data-k')]=el.value;
        saveState();
      });
    })(txts[i]);
  }
  // bind edit/del finding
  var edbs=body.querySelectorAll('[data-edit]');
  for(var i=0;i<edbs.length;i++){
    (function(el){el.addEventListener('click',function(){editFinding(parseInt(el.getAttribute('data-edit')));});})(edbs[i]);
  }
  var dbs=body.querySelectorAll('[data-del]');
  for(var i=0;i<dbs.length;i++){
    (function(el){el.addEventListener('click',function(){deleteFinding(parseInt(el.getAttribute('data-del')));});})(dbs[i]);
  }
  ge('btnAddF').addEventListener('click',function(){openAddFinding(curSec);});
}

/* ── FINDING FORM ── */
function openAddFinding(sid){
  curSec=sid; editId=null; fPhoto=null; selType=null;
  var s=getSec(sid);
  ge('fTitle').textContent='Add Finding';
  ge('fSub').textContent=s.name;
  ge('fDesc').value='';
  ge('fLoc').value='';
  ge('fAction').value='';
  clearTypeGrid();
  resetFPhoto();
  startDt();
  showS('finding');
}

function editFinding(id){
  var f=null;
  for(var i=0;i<ST.findings.length;i++){if(ST.findings[i].id===id){f=ST.findings[i];break;}}
  if(!f)return;
  editId=id; curSec=f.sid; fPhoto=f.photo||null; selType=f.type;
  var s=getSec(f.sid);
  ge('fTitle').textContent='Edit Finding';
  ge('fSub').textContent=s.name;
  ge('fDesc').value=f.desc||'';
  ge('fLoc').value=f.loc||'';
  ge('fAction').value=f.action||'';
  clearTypeGrid();
  if(selType){
    var opt=document.querySelector('.topt[data-k="'+selType+'"]');
    if(opt)opt.classList.add(TS[selType]);
  }
  if(f.photo)setFPrev(f.photo); else resetFPhoto();
  startDt();
  showS('finding');
}

function clearTypeGrid(){
  var opts=document.querySelectorAll('.topt');
  for(var i=0;i<opts.length;i++){
    var k=opts[i].getAttribute('data-k');
    if(TS[k])opts[i].classList.remove(TS[k]);
  }
}

function startDt(){
  clearInterval(dtTmr);
  function upd(){var n=new Date();ge('dtD').textContent=fmtD(n);ge('dtT').textContent=fmtT(n);}
  upd(); dtTmr=setInterval(upd,1000);
}

function setFPrev(src){
  var a=ge('photoArea');
  a.className='parea has';
  a.innerHTML='<img src="'+src+'" alt=""/>'
    +'<div class="pover"><button class="bret" id="btnRet">Retake</button></div>';
  a.onclick=null;
  var rb=ge('btnRet');
  if(rb)rb.addEventListener('click',function(e){e.stopPropagation();resetFPhoto();});
}

function resetFPhoto(){
  fPhoto=null;
  var a=ge('photoArea');
  a.className='parea';
  a.innerHTML='<div class="pph"><div class="pi">&#128248;</div>'
    +'<div class="pt">Tap to take / select photo</div>'
    +'<div class="ps">Optional</div></div>';
  a.onclick=function(){ge('fCamInput').click();};
  ge('fCamInput').value='';
}

function doSaveFinding(){
  var desc=ge('fDesc').value.trim();
  var loc=ge('fLoc').value.trim();
  var action=ge('fAction').value.trim();
  if(!desc){toast('Please add a description','er');return;}
  if(!selType){toast('Please select a finding type','er');return;}
  var now=new Date();
  var entry={id:editId||Date.now(),sid:curSec,type:selType,desc:desc,loc:loc,action:action,photo:fPhoto,date:fmtD(now),time:fmtT(now)};
  if(editId){
    for(var i=0;i<ST.findings.length;i++){if(ST.findings[i].id===editId){ST.findings[i]=entry;break;}}
  } else {
    ST.findings.push(entry);
  }
  saveState();
  clearInterval(dtTmr);
  toast('Finding saved','ok');
  openSection(curSec);
}

function deleteFinding(id){
  var nf=[];
  for(var i=0;i<ST.findings.length;i++){if(ST.findings[i].id!==id)nf.push(ST.findings[i]);}
  ST.findings=nf;
  saveState();
  renderSecBody(getSec(curSec));
  toast('Finding deleted');
}

/* ── REVIEW ── */
function openReview(){
  ge('revSub').textContent=ST.findings.length+' total findings';
  var html='';
  var any=false;
  for(var i=0;i<SECS.length;i++){
    var s=SECS[i];
    var finds=[];
    for(var j=0;j<ST.findings.length;j++){if(ST.findings[j].sid===s.id)finds.push(ST.findings[j]);}
    if(!finds.length)continue;
    any=true;
    html+='<div style="font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--text3);margin:12px 0 8px 2px;">'+esc(s.name)+' ('+finds.length+')</div>';
    for(var j=0;j<finds.length;j++){
      var f=finds[j];
      html+='<div class="rcard">'
        +'<div class="rhd"><span class="rsn">'+esc(s.name)+'</span><span class="tbadge '+(TC[f.type]||'tbo')+'">'+esc(TL[f.type]||f.type)+'</span></div>'
        +'<div class="rbdy">'
          +(f.photo?'<img class="rimg" src="'+f.photo+'" alt=""/>':'')
          +'<div class="rdesc">'+esc(f.desc)+'</div>'
          +'<div class="rmeta">'
            +'<div class="rmi"><div class="rl">Location</div><div class="rv">'+esc(f.loc||'—')+'</div></div>'
            +'<div class="rmi"><div class="rl">Date/Time</div><div class="rv">'+esc(f.date)+' '+esc(f.time)+'</div></div>'
          +'</div>'
          +(f.action?'<div class="ract"><div class="al">Recommended Action</div><div class="av">'+esc(f.action)+'</div></div>':'')
        +'</div>'
        +'</div>';
    }
  }
  if(!any)html='<div class="empty"><div class="ei">&#128203;</div><p>No findings recorded yet.</p></div>';
  ge('revBody').innerHTML=html;
  showS('review');
}

/* ── EXPORT ── */
function doExportJSON(){
  var out={generatedAt:new Date().toISOString(),sections:[]};
  for(var i=0;i<SECS.length;i++){
    var s=SECS[i];
    var obj={id:s.id,name:s.name,photos:[],findings:[]};
    for(var j=0;j<s.slots.length;j++){
      obj.photos.push({slot:s.slots[j].lbl,hasPhoto:!!ST.photos[s.slots[j].k],note:ST.notes[s.slots[j].k]||''});
    }
    for(var j=0;j<ST.findings.length;j++){
      var f=ST.findings[j];
      if(f.sid===s.id)obj.findings.push({type:TL[f.type]||f.type,desc:f.desc,location:f.loc,action:f.action,date:f.date,time:f.time});
    }
    out.sections.push(obj);
  }
  dlF('ship_survey.json',JSON.stringify(out,null,2),'application/json');
}
function doExportCSV(){
  var rows=[['Section','Finding Type','Description','Location','Action','Date','Time']];
  for(var i=0;i<ST.findings.length;i++){
    var f=ST.findings[i];
    var s=getSec(f.sid);
    rows.push([s?s.name:f.sid,TL[f.type]||f.type,f.desc,f.loc||'',f.action||'',f.date,f.time]);
  }
  var csv=rows.map(function(r){return r.map(function(v){return '"'+(v||'').replace(/"/g,'""')+'"';}).join(',');}).join('\n');
  dlF('ship_survey.csv',csv,'text/csv');
}
function dlF(name,content,type){
  var b=new Blob([content],{type:type});
  var u=URL.createObjectURL(b);
  var a=document.createElement('a');a.href=u;a.download=name;
  document.body.appendChild(a);a.click();document.body.removeChild(a);
  URL.revokeObjectURL(u);
  toast(name+' exported!','ok');
}

/* ── INIT ── */
document.addEventListener('DOMContentLoaded',function(){
  ge('btnReview').addEventListener('click',openReview);
  ge('btnExpJSON').addEventListener('click',doExportJSON);
  ge('btnExpCSV').addEventListener('click',doExportCSV);
  ge('btnSecBack').addEventListener('click',function(){clearInterval(dtTmr);showS('home');initHome();});
  ge('btnFindBack').addEventListener('click',function(){clearInterval(dtTmr);openSection(curSec);});
  ge('btnRevBack').addEventListener('click',function(){showS('home');initHome();});
  ge('btnSave').addEventListener('click',doSaveFinding);

  // type options
  var topts=document.querySelectorAll('.topt');
  for(var i=0;i<topts.length;i++){
    (function(el){
      el.addEventListener('click',function(){
        clearTypeGrid();
        var k=el.getAttribute('data-k');
        selType=k;
        if(TS[k])el.classList.add(TS[k]);
      });
    })(topts[i]);
  }

  // finding camera
  ge('fCamInput').addEventListener('change',function(){
    var file=ge('fCamInput').files[0]; if(!file)return;
    var r=new FileReader();
    r.onload=function(ev){fPhoto=ev.target.result;setFPrev(fPhoto);};
    r.readAsDataURL(file);
  });
  ge('photoArea').addEventListener('click',function(){ge('fCamInput').click();});

  initHome();
});
</script>
</body>
</html>
